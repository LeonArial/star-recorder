services:
  asr-api:
    platform: linux/amd64
    build:
      context: .
      dockerfile: Dockerfile
    container_name: star-recorder-asr
    image: 10.8.101.91/autoreport/star_recorder
    
    # GPU支持（推荐方式）
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu, compute, utility]
    
    # 端口映射
    ports:
      - "5006:5006"
    
    # 卷挂载
    volumes:
      # 模型缓存目录（避免重复下载）
      - ./models_cache:/root/.cache/modelscope
      - ./hf_cache:/root/.cache/huggingface
      
      # 热词配置文件（可动态修改）
      - ./hotwords.json:/app/hotwords.json
      
      # 日志目录
      - ./logs:/app/logs
    
    # 环境变量
    environment:
      - CUDA_VISIBLE_DEVICES=0
      - MODELSCOPE_CACHE=/root/.cache/modelscope
      - HF_HOME=/root/.cache/huggingface
      - PYTHONUNBUFFERED=1
    
    # 重启策略
    restart: unless-stopped
    
    # 健康检查
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5006/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    
    # 网络模式
    network_mode: bridge
    
    # 资源限制（可选，根据实际情况调整）
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '8'
    #       memory: 16G
    #     reservations:
    #       cpus: '4'
    #       memory: 8G
